### Verkkoon tunkeutuminen ja tiedustelu ICI013AS3A-3002

### Abdirahman Mire

### Työympäristö:

Käyttöjärjestelmä: Windows 11 Pro 64-bit

CPU: Intel Core i7-12700KF

RAM: 6 GB DDR4

Disk: 40gb

Virtuaalikone: VMware, Kali Linux


## H2 Lempiväri Violetti


### X) Pyramid of pain ja Diamond model

- Pyramid of Pain kuvaa miten vaikeaa hyökkääjien seuraaminen on eri indikaattoreilla korkeamman tason indikaattoreiden (esim. TTP) muuttaminen aiheuttaa eniten tuskaa hyökkääjälle.
  
- Diamond Model, jakaa hyökkäyksen neljään osaan Adversary, Capability, Infrastructure, Victim ja korostaa niiden välisiä yhteyksiä ja vuorovaikutusta.
  
### A) Apache log. Asenna Apache-weppipalvelin paikalliselle virtuaalikoneellesi. Surffaa palvelimellesi salaamattomalla HTTP-yhteydellä, http://localhost . Etsi omaa sivulataustasi vastaava lokirivi. Analysoi yksi tällainen lokirivi, eli selitä sen kaikki kohdat. (Jos Apache ei ole kovin tuttu, voit tätä tehtävää varten vain asentaa sen ja testata oletusweppisivulla. Eli ei tarvitse tehdä omia kotisvuja tms.)

Apache2 jo asennettuna. Käynnistin komennolla `sudo systemctl start apache2`.

![kuva1](/H2/kuvat/kuva1.png)

Surffasin firefoxilla sivulle http://localhost

Etsin oman sivun latausta vastaavan lokirivin komennolla `sudo tail -F /var/log/apache2/access.log`

![kuva1](/H2/kuvat/kuva2.png)

`127.0.0.1 - - [02/Nov/2025:14:18:25 -0500] "GET / HTTP/1.1" 200 3383 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0"`


`127.0.0.1` = Asiakas(client)

`[02/Nov/2025:14:18:25 -0500]` = Päivä, aika ja vyöhyke

`GET / HTTP/1.1` = HTTP GET-pyyntö

`Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0` = Käyttäjän selaimen tyyppi ja versio.

### B) Nmapped. Porttiskannaa oma weppipalvelimesi käyttäen localhost-osoitetta ja 'nmap -A' päällä. Selitä tulokset.

Katkaisin yhteyden internettiin ja varmistin `ping 8.8.8.8`

![kuva1](/H2/kuvat/kuva3.png)

`sudo nmap -A localhost`

![kuva1](/H2/kuvat/kuva4.png)

Portti 80/tcp on auki, palveluna on apache http 2.4.65. Web-palvelin on käynnissä.


### C) Skriptit. Mitkä skriptit olivat automaattisesti päällä, kun käytit "-A" parametria?

komennolla: `man nmap` etsin parametrin -A. OS detection, version dedection ja trace route.

![kuva1](/H2/kuvat/kuva5.png)

### D) Jäljet lokissa. Etsi weppipalvelimen lokeista jäljet porttiskannauksesta (NSE eli Nmap Scripting Engine -skripteistä skannauksessa). Löydätkö sanan "nmap" isolla tai pienellä? Selitä osumat. Millaisilla hauilla tai säännöillä voisit tunnistaa porttiskannauksen jostain muusta lokista, jos se on niin laaja, että et pysty lukemaan itse kaikkia rivejä?

`sudo tail -F /var/log/apache2/access.log`

![kuva1](/H2/kuvat/kuva6.png)

Löysin lokista jäljet porttiskannauksesta, lukee suoraan Nmap Scripting Engine.

Esimerkiksi seuraavalla haulla:   `sudo grep -i "nmap" /var/log/apache2/access.log` 

komennossa parametri -i ei huomioi isoja tai pieniä kirjaimia (case-sensitive)


### E) Wire sharking. Sieppaa verkkoliikenne porttiskannatessa Wiresharkilla. Huomaa, että localhost käyttää "Loopback adapter" eli "lo". Tallenna pcap. Etsi kohdat, joilla on sana "nmap" ja kommentoi niitä. Jokaisen paketin jokaista kohtaa ei tarvitse analysoida, yleisempi tarkastelu riittää.

Laitoin wiresharkin sieppaamaan Loopback adapteria ja aloitin porttiskannauksen: 

`sudo nmap -A localhost`

Filtteröin siepatun verkkoliikenteen:  frame contains "nmap"

![kuva1](/H2/kuvat/kuva7.png)

Useammassa paketissa (HTTP) user-agentin kohdalla lukee Nmap scripting Engine.

### F) Net grep. Sieppaa verkkoliikenne 'ngrep' komennolla ja näytä kohdat, joissa on sana "nmap".

komento: `sudo ngrep -d lo -i nmap`

![kuva1](/H2/kuvat/kuva8.png)


### G & H) Agentti. Vaihda nmap:n user-agent niin, että se näyttää tavalliselta weppiselaimelta. Porttiskannaa weppipalvelimesi uudelleen localhost-osoitteella. Tarkastele sekä Apachen lokia että siepattua verkkoliikennettä. Mikä on muuttunut, kun vaihdoit user-agent:n? Löytyykö lokista edelleen tekstijono "nmap"? 

Vaihdoin user-agentin niin että näyttää Mozilla/5.0 (X11; Linux x86_64) lisäämällä parametrin --script-args http.useragent="Mozilla/5.0:
`sudo nmap -A --script-args http.useragent="Mozilla/5.0 (X11; Linux x86_64)" localhost`

![kuva1](/H2/kuvat/kuva9.png)

Sieppasin verkkoliikenteen wiresharkilla ja kun filtteröin frame contains "nmap" löytyi vain yksi paketti

![kuva1](/H2/kuvat/kuva10.png)

Tarkistin lokin `sudo grep -i "nmap" /var/log/apache2/access.log`

![kuva1](/H2/kuvat/kuva11.png)

lokista yhä näkee Nmap Scripting Engine. 

### i) Hieman vaikeampi: LoWeR ChEcK. Poista skritiskannauksesta viimeinenkin "nmap" -teksti. Etsi löytämääsi tekstiä /usr/share/nmap -hakemistosta ja korvaa se toisella. Tee porttiskannaus ja tarkista, että "nmap" ei näy isolla eikä pienellä kirjoitettuna Apachen lokissa eikä siepatussa verkkoliikenteessä. (Tässä tehtävässä voit muokata suoraan lua-skriptejä /usr/share/nmap alta, 'sudoedit'. Muokatun version paketoiminen siis rajataan ulos tehtävästä.)

Suunnistin hakemistoon /usr/share/nmap ja hain grep -ir "Nmap Scripting Engine"  

![kuva1](/H2/kuvat/kuva12.png)

löysin http.lua nimisen tiedoston joka näytti mielenkiintoiselta. 

Muokkasin seuraavanlailla: 

![kuva1](/H2/kuvat/kuva13.png)

![kuva1](/H2/kuvat/kuva14.png)

Eli kokeilin yksinkertaisesti ottaa pois tuon Nmap scripting Engine osuuden pois. 
kokeilin siepata ja etsiä mutta epäonnistuneesti sama tulos kuin tuossa edellisessä tehtävässä, yhä yksi paketti jossa lukee Nmap wiresharkissa. 

Referenssit: 

TeroKarvinen: https://terokarvinen.com/verkkoon-tunkeutuminen-ja-tiedustelu/

Diamond model: https://kravensecurity.com/diamond-model-analysis/

Pyramid model: https://detect-respond.blogspot.com/2013/03/the-pyramid-of-pain.html
